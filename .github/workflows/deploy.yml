name: Deploy to Tencent Cloud

on:
  push:
    branches:
      - main

# 2026 权限管理：允许写入 GitHub Packages (GHCR)
permissions:
  contents: read
  packages: write

jobs:
  # ============================================
  # 阶段 1：构建并推送镜像 (Stateless Build)
  # ============================================
  build:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,format=long
            latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max

  # ============================================
  # 阶段 2：部署到 K3s 集群 (Helm Chart)
  # ============================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to K3s Cluster
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # 1. 安装 External Secrets Operator (如果尚未安装)
            echo "=== Installing External Secrets Operator ==="
            helm repo add external-secrets https://charts.external-secrets.io || true
            helm repo update
            helm upgrade --install external-secrets \
              external-secrets/external-secrets \
              -n external-secrets \
              --create-namespace \
              --version 0.10.0 \
              --set installCRDs=true \
              --wait --timeout 10m || true

            # 2. 创建 GHCR 镜像拉取密钥
            echo "=== Creating GHCR secret ==="
            kubectl create secret docker-registry ghcr-secret \
              --docker-server=ghcr.io \
              --docker-username=${{ github.actor }} \
              --docker-password=${{ secrets.GITHUB_TOKEN }} \
              --namespace=nexusnote \
              --dry-run=client -o yaml | kubectl apply -f -

            # 3. 创建 GitHub Token Secret (用于 ESO 从 GitHub Secrets 读取)
            echo "=== Creating GitHub token for ESO ==="
            kubectl create secret generic github-token \
              --from-literal=token=${{ secrets.GITHUB_TOKEN }} \
              --namespace=nexusnote \
              --dry-run=client -o yaml | kubectl apply -f -

            # 4. 应用 SecretStore (配置 ESO 使用 GitHub 作为 Provider)
            echo "=== Applying SecretStore ==="
            kubectl apply -f deploy/k8s/secretstore-github.yaml

            # 5. 应用 ExternalSecret (从 GitHub Secrets 同步到 K8s Secrets)
            echo "=== Applying ExternalSecret ==="
            kubectl apply -f deploy/k8s/externalsecret.yaml

            # 6. 等待 ExternalSecret 同步完成
            echo "=== Waiting for ExternalSecret to sync ==="
            kubectl wait --for=condition=Ready externalsecret/nexusnote-secrets -n nexusnote --timeout=300s || {
              echo "ERROR: ExternalSecret failed to sync"
              kubectl get externalsecret/nexusnote-secrets -n nexusnote -o yaml
              kubectl logs -n external-secrets deployment/external-secrets --tail=50
              exit 1
            }

            # 7. 部署前验证
            echo "=== Running pre-deploy validation ==="

            # 检查 Secret 完整性
            echo "Checking secrets..."
            kubectl get secret nexusnote-secrets -n nexusnote || {
              echo "ERROR: Secret nexusnote-secrets not found"
              exit 1
            }

            # 验证镜像可访问
            echo "Validating image..."
            IMAGE_TAG="ghcr.io/${{ github.repository }}:sha-${{ github.sha }}"
            docker manifest inspect $IMAGE_TAG || {
              echo "ERROR: Image $IMAGE_TAG not accessible"
              exit 1
            }

            echo "=== Validation passed ==="

            # 8. 使用 Helm 部署
            echo "=== Deploying with Helm ==="
            helm repo add nexusnote https://github.com/nexusnote/nexusnote/releases/download || true

            # 生产环境部署
            helm upgrade --install nexusnote ./deploy/k8s/chart \
              --namespace nexusnote \
              --create-namespace \
              --set image.tag="sha-${{ github.sha }}" \
              --set image.repository="ghcr.io/${{ github.repository }}" \
              --values ./deploy/k8s/chart/values-prod.yaml \
              --wait --timeout 10m

            # 9. 健康检查和自动回滚
            echo "=== Checking deployment health ==="

            # 等待 web 滚动更新完成
            echo "Waiting for web rollout..."
            timeout 600 kubectl rollout status deployment/nexusnote-web -n nexusnote || {
              echo "ERROR: Web deployment failed, rolling back..."
              helm rollback nexusnote -n nexusnote
              kubectl rollout status deployment/nexusnote-web -n nexusnote --timeout=300s
              exit 1
            }

            # 等待 collab 滚动更新完成
            echo "Waiting for collab rollout..."
            timeout 600 kubectl rollout status deployment/nexusnote-collab -n nexusnote || {
              echo "ERROR: Collab deployment failed, rolling back..."
              helm rollback nexusnote -n nexusnote
              kubectl rollout status deployment/nexusnote-collab -n nexusnote --timeout=300s
              exit 1
            }

            # 等待 worker 滚动更新完成
            echo "Waiting for worker rollout..."
            timeout 600 kubectl rollout status deployment/nexusnote-worker -n nexusnote || {
              echo "ERROR: Worker deployment failed, rolling back..."
              helm rollback nexusnote -n nexusnote
              kubectl rollout status deployment/nexusnote-worker -n nexusnote --timeout=300s
              exit 1
            }

            # 验证 Pod 健康
            echo "Checking pod health..."
            kubectl wait --for=condition=ready pod -l app=nexusnote-web -n nexusnote --timeout=300s || {
              echo "ERROR: Web pods not ready, rolling back..."
              helm rollback nexusnote -n nexusnote
              exit 1
            }
            kubectl wait --for=condition=ready pod -l app=nexusnote-collab -n nexusnote --timeout=300s || {
              echo "ERROR: Collab pods not ready, rolling back..."
              helm rollback nexusnote -n nexusnote
              exit 1
            }
            kubectl wait --for=condition=ready pod -l app=nexusnote-worker -n nexusnote --timeout=300s || {
              echo "ERROR: Worker pods not ready, rolling back..."
              helm rollback nexusnote -n nexusnote
              exit 1
            }

            # 验证服务可访问
            echo "Verifying service accessibility..."
            kubectl get svc nexusnote-web -n nexusnote || {
              echo "ERROR: Web service not found"
              exit 1
            }
            kubectl get svc nexusnote-collab -n nexusnote || {
              echo "ERROR: Collab service not found"
              exit 1
            }

            echo "=== Deployment successful ==="
