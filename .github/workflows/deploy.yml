name: Deploy to Tencent Cloud

on:
  push:
    branches:
      - main

# 2026 权限管理：允许写入 GitHub Packages (GHCR)
permissions:
  contents: read
  packages: write

jobs:
  # ============================================
  # 阶段 1：构建镜像 + 打包配置
  # ============================================
  build:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_sha: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,format=long

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max

      # 下载 External Secrets Operator Helm Chart
      - name: Download ESO Helm Chart
        run: |
          rm -rf deploy/k8s/charts
          mkdir -p deploy/k8s/charts
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update
          helm pull external-secrets/external-secrets --version 2.0.0 --destination deploy/k8s/charts/

      # 上传 K8s 配置文件为 Artifact（包含 Helm Chart）
      - name: Upload K8s Configs
        uses: actions/upload-artifact@v4
        with:
          name: k8s-configs
          path: deploy/k8s/

  # ============================================
  # 阶段 2：部署到 K3s (无代码克隆，使用 Artifacts)
  # ============================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      # 下载配置到 Runner
      - name: Download K8s Configs
        uses: actions/download-artifact@v4
        with:
          name: k8s-configs
          path: deploy/k8s/

      # 清空服务器旧部署目录
      - name: Clean server deploy directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            rm -rf /tmp/nexusnote-deploy || true

      # 传输配置到服务器
      - name: Copy configs to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/k8s/"
          target: "/tmp/nexusnote-deploy"
          strip_components: 0

      # 执行部署
      - name: Deploy to K3s Cluster
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            # 自动定位配置目录（兼容不同的 scp 行为）
            CONFIG_DIR=$(find /tmp/nexusnote-deploy -type d -name "k8s" | head -n 1)
            if [ -z "$CONFIG_DIR" ]; then
              # 兜底：如果找不到 k8s 目录，可能就在根目录
              CONFIG_DIR="/tmp/nexusnote-deploy"
            fi
            echo "Config directory: $CONFIG_DIR"
            cd "$CONFIG_DIR"

            # 1. 安装 External Secrets Operator (离线安装模式)
            echo "=== Installing External Secrets Operator (Offline) ==="
            CHART_FILE=$(ls charts/external-secrets-*.tgz)
            helm upgrade --install external-secrets "$CHART_FILE" \
              -n external-secrets \
              --create-namespace \
              --set installCRDs=true \
              --wait --timeout 10m || {
              echo "ERROR: ESO installation failed"
              exit 1
              }

            # 2. 创建 GHCR 镜像拉取密钥
              echo "=== Creating GHCR secret ==="
              kubectl create secret docker-registry ghcr-secret \
                --docker-server=ghcr.io \
                --docker-username=${{ github.actor }} \
                --docker-password=${{ secrets.GITHUB_TOKEN }} \
                --namespace=nexusnote \
                --dry-run=client -o yaml | kubectl apply -f -

              # 3. 创建 GitHub Token Secret (用于 ESO 从 GitHub Secrets 读取)
              echo "=== Creating GitHub token for ESO ==="
              kubectl create secret generic github-token \
                --from-literal=token=${{ secrets.GITHUB_TOKEN }} \
                --namespace=nexusnote \
                --dry-run=client -o yaml | kubectl apply -f -

              # 4. 应用 SecretStore (配置 ESO 使用 GitHub 作为 Provider)
              echo "=== Applying SecretStore ==="
              # 使用 sed 替换变量（避免 envsubst 未安装问题）
              sed -i "s/\${GITHUB_OWNER}/${{ github.repository_owner }}/g" secretstore-github.yaml
              kubectl apply -f secretstore-github.yaml

              # 5. 应用 ExternalSecret (从 GitHub Secrets 同步到 K8s Secrets)
              echo "=== Applying ExternalSecret ==="
              kubectl apply -f externalsecret.yaml

              # 6. 等待 ExternalSecret 同步完成
              echo "=== Waiting for ExternalSecret to sync ==="
            kubectl wait --for=condition=Ready externalsecret/nexusnote-secrets -n nexusnote --timeout=300s || {
              echo "ERROR: ExternalSecret failed to sync"
              kubectl get externalsecret/nexusnote-secrets -n nexusnote -o yaml
              kubectl logs -n external-secrets deployment/external-secrets --tail=50
              exit 1
            }

            # 7. 部署前验证
            echo "=== Running pre-deploy validation ==="

            # 检查 Secret 完整性
            echo "Checking secrets..."
            kubectl get secret nexusnote-secrets -n nexusnote || {
              echo "ERROR: Secret nexusnote-secrets not found"
              exit 1
            }

            echo "=== Validation passed ==="

            # 8. 使用 Helm 部署
            echo "=== Deploying with Helm ==="
            # 生产环境部署
            helm upgrade --install nexusnote ./chart \
              --namespace nexusnote \
              --create-namespace \
              --set image.tag="sha-${{ needs.build.outputs.image_sha }}" \
              --set image.repository="ghcr.io/${{ github.repository }}" \
              --values ./chart/values-prod.yaml \
              --atomic \
              --wait --timeout 10m

            # 9. 健康检查和自动回滚
            echo "=== Checking deployment health ==="

            # 等待 web 滚动更新完成
            echo "Waiting for web rollout..."
            timeout 600 kubectl rollout status deployment/nexusnote-web -n nexusnote || {
              echo "ERROR: Web deployment failed, rolling back..."
              helm rollback nexusnote -n nexusnote
              kubectl rollout status deployment/nexusnote-web -n nexusnote --timeout=300s
              exit 1
            }

            # 等待 collab 滚动更新完成
            echo "Waiting for collab rollout..."
            timeout 600 kubectl rollout status deployment/nexusnote-collab -n nexusnote || {
              echo "ERROR: Collab deployment failed, rolling back..."
              helm rollback nexusnote -n nexusnote
              kubectl rollout status deployment/nexusnote-collab -n nexusnote --timeout=300s
              exit 1
            }

            # 等待 worker 滚动更新完成
            echo "Waiting for worker rollout..."
            timeout 600 kubectl rollout status deployment/nexusnote-worker -n nexusnote || {
              echo "ERROR: Worker deployment failed, rolling back..."
              helm rollback nexusnote -n nexusnote
              kubectl rollout status deployment/nexusnote-worker -n nexusnote --timeout=300s
              exit 1
            }

            # 验证 Pod 健康
            echo "Checking pod health..."
            kubectl wait --for=condition=ready pod -l app=nexusnote-web -n nexusnote --timeout=300s || {
              echo "ERROR: Web pods not ready, rolling back..."
              helm rollback nexusnote -n nexusnote
              exit 1
            }
            kubectl wait --for=condition=ready pod -l app=nexusnote-collab -n nexusnote --timeout=300s || {
              echo "ERROR: Collab pods not ready, rolling back..."
              helm rollback nexusnote -n nexusnote
              exit 1
            }
            kubectl wait --for=condition=ready pod -l app=nexusnote-worker -n nexusnote --timeout=300s || {
              echo "ERROR: Worker pods not ready, rolling back..."
              helm rollback nexusnote -n nexusnote
              exit 1
            }

            # 验证服务可访问
            echo "Verifying service accessibility..."
            kubectl get svc nexusnote-web -n nexusnote || {
              echo "ERROR: Web service not found"
              exit 1
            }
            kubectl get svc nexusnote-collab -n nexusnote || {
              echo "ERROR: Collab service not found"
              exit 1
            }

            # 清理临时文件
            echo "=== Cleaning up temporary files ==="
            rm -rf /tmp/nexusnote-deploy

            echo "=== Deployment successful ==="
