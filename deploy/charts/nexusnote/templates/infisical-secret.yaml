# ===========================================
# InfisicalSecret - 从 Infisical 同步 Secrets
# ===========================================
# 此 CRD 告诉 Infisical Operator 从 Infisical 项目同步 Secrets
# 并创建 Kubernetes Secret

{{- if .Values.infisical.enabled }}
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: nexusnote-secrets
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "nexusnote.labels" . | nindent 4 }}
spec:
  # 同步间隔（秒）
  resyncInterval: {{ .Values.infisical.resyncInterval | default 60 }}

  # 认证配置
  authentication:
    universalAuth:
      # 从 Kubernetes Secret 读取凭证（更安全）
      credentialsRef:
        secretName: {{ .Values.infisical.credentialsSecret | default "infisical-credentials" }}
        secretNamespace: {{ .Values.namespace }}

  # 目标 Kubernetes Secret 配置
  managedSecretReference:
    secretName: nexusnote-secrets
    secretNamespace: {{ .Values.namespace }}
    # 当 Infisical Secret 更新时自动重启 Pod
    creationPolicy: Owner

  # Secret 同步范围
  secretsScope:
    projectSlug: {{ .Values.infisical.projectSlug | quote }}
    envSlug: {{ .Values.infisical.envSlug | default "prod" | quote }}
    secretsPath: /
    # 是否递归获取子文件夹的 secrets
    recursive: false

  # 自动重启使用此 Secret 的 Deployments
  autoRedeployEnabled: true
  autoRedeployTarget:
    kind: Deployment
    name: nexusnote-web
{{- end }}

---
# ===========================================
# Infisical 认证凭证 Secret
# ===========================================
# 注意：生产环境建议使用 External Secrets 或手动创建
# 此处仅作为示例

{{- if and .Values.infisical.enabled .Values.infisical.clientId .Values.infisical.clientSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.infisical.credentialsSecret | default "infisical-credentials" }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "nexusnote.labels" . | nindent 4 }}
type: Opaque
stringData:
  clientId: {{ .Values.infisical.clientId | quote }}
  clientSecret: {{ .Values.infisical.clientSecret | quote }}
{{- end }}
