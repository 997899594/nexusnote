# ===========================================
# NexusNote Gateway Infrastructure
# ===========================================
# 使用 Cilium Gateway API + LB-IPAM

---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: nexusnote-gateway
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "nexusnote.labels" . | nindent 4 }}
  annotations:
    # 使用集群级 ClusterIssuer（在 deploy/infra/cert-manager/ 中定义）
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # Cilium LB-IPAM 配置
    io.cilium/lb-ipam-ips: {{ .Values.loadBalancerIP | default "10.2.0.15" | quote }}
spec:
  gatewayClassName: cilium
  listeners:
    # HTTP 监听器（重定向到 HTTPS）
    # hostname 必须显式指定，Cilium 1.16 对无 hostname 的 listener 不生成 RDS 路由
    - name: http
      protocol: HTTP
      port: 80
      hostname: {{ include "nexusnote.hostname" . | quote }}
      allowedRoutes:
        namespaces:
          from: Same
    # HTTPS 监听器
    - name: https
      protocol: HTTPS
      port: 443
      hostname: {{ include "nexusnote.hostname" . | quote }}
      allowedRoutes:
        namespaces:
          from: Same
      tls:
        mode: Terminate
        certificateRefs:
          - name: nexusnote-tls
            kind: Secret

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: nexusnote-route
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "nexusnote.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: nexusnote-gateway
      namespace: {{ .Values.namespace }}
      kind: Gateway
      # 只绑定 HTTPS listener，HTTP 由 nexusnote-redirect 处理重定向
      # cert-manager solver 的 Exact 匹配优先于重定向的 PathPrefix
      sectionName: https
  hostnames:
    - {{ include "nexusnote.hostname" . | quote }}
  rules:
    # WebSocket 路由（协作服务）
    - matches:
        - path:
            type: PathPrefix
            value: /collab
      backendRefs:
        - name: nexusnote-collab
          port: {{ .Values.env.HOCUSPOCUS_PORT | default 1234 }}
    # 主应用路由
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: nexusnote-web
          port: {{ .Values.env.PORT | default 3000 }}

---
# HTTP 到 HTTPS 重定向
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: nexusnote-redirect
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "nexusnote.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: nexusnote-gateway
      namespace: {{ .Values.namespace }}
      kind: Gateway
      sectionName: http
  hostnames:
    - {{ include "nexusnote.hostname" . | quote }}
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
