# ===========================================
# Database Migration Job
# ===========================================
apiVersion: batch/v1
kind: Job
metadata:
  name: nexusnote-db-migrate
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "nexusnote.labels" . | nindent 4 }}
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
      initContainers:
        - name: wait-for-secrets
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for secrets to be available..."
              until [ -n "$DATABASE_URL" ] || [ -n "$POSTGRES_PASSWORD" ]; do
                echo "Secrets not ready, waiting..."
                sleep 2
              done
              echo "Secrets available."
          envFrom:
            - secretRef:
                name: nexusnote-secrets
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
        - name: wait-for-db
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for PostgreSQL..."
              until node -e "
                const net = require('net');
                const s = new net.Socket();
                s.connect({{ .Values.database.port }}, '{{ .Values.database.host }}', () => { s.end(); process.exit(0); });
                s.on('error', () => process.exit(1));
                setTimeout(() => process.exit(1), 3000);
              "; do
                echo "PostgreSQL not ready, retrying..."
                sleep 3
              done
              echo "PostgreSQL is ready."
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      containers:
        - name: db-migrate
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Running database migrations..."
              npx drizzle-kit push --config drizzle.config.ts
              echo "Migrations completed."
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
