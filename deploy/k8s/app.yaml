apiVersion: v1
kind: ConfigMap
metadata:
  name: nexusnote-config
  namespace: nexusnote
data:
  # 服务器配置
  PORT: "3002"
  HOCUSPOCUS_PORT: "1234"

  # JWT 配置 (非敏感部分)
  JWT_EXPIRES_IN: "7d"
  JWT_ISSUER: "nexusnote"

  # AI 模型配置 (默认值)
  AI_MODEL: "gemini-3-flash-preview"
  AI_MODEL_PRO: "gemini-3-pro-preview"
  AI_MODEL_WEB_SEARCH: "gemini-3-flash-preview-web-search"

  # Embedding & Reranker
  EMBEDDING_MODEL: "Qwen/Qwen3-Embedding-8B"
  EMBEDDING_DIMENSIONS: "4000"
  RERANKER_MODEL: "Qwen/Qwen3-Reranker-8B"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-app
  namespace: nexusnote
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: nexusnote
  template:
    metadata:
      labels:
        app: nexusnote
    spec:
      imagePullSecrets:
        - name: tcr-io-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          ports:
            - containerPort: 3002
              name: http
            - containerPort: 1234
              name: collab
          envFrom:
            - secretRef:
                name: nexusnote-secrets
            - configMapRef:
                name: nexusnote-config
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3002
            initialDelaySeconds: 30
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3002
            initialDelaySeconds: 10
            periodSeconds: 10
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "200m"
              memory: "256Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote
  ports:
    - name: http
      port: 80
      targetPort: 3002
    - name: collab
      port: 1234
      targetPort: 1234
