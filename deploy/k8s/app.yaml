apiVersion: v1
kind: ConfigMap
metadata:
  name: nexusnote-config
  namespace: nexusnote
data:
  NODE_ENV: "production"
  PORT: "3002"
  HOCUSPOCUS_PORT: "3003"
  NEXT_PUBLIC_APP_URL: "https://juanie.art"
  AUTH_TRUST_HOST: "true"
  NEXTAUTH_URL: "https://juanie.art"
  # OAuth Providers
  AUTH_GITHUB_ID: "Ov23li5kloVVHQeOSefR"
  AUTH_GITHUB_SECRET: "3e6be8df8fefb894da3b9bf5c8bc3e23030fb666"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-web
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-web
  template:
    metadata:
      labels:
        app: nexusnote-web
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          command: ["node", "apps/web/server.js"]
          ports:
            - containerPort: 3002
              name: http
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-collab
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-collab
  template:
    metadata:
      labels:
        app: nexusnote-collab
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          command: ["node", "apps/web/hocuspocus.js"]
          ports:
            - containerPort: 3003
              name: collab
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-worker
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-worker
  template:
    metadata:
      labels:
        app: nexusnote-worker
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          command: ["node", "apps/web/worker.js"]
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"

---
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3002
---
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-collab-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote-collab
  ports:
    - protocol: TCP
      port: 3003
      targetPort: 3003
