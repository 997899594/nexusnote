# ============================================
# 应用部署配置 - Web / Collab / Worker 服务
# ============================================

# ============================================
# 1. ConfigMap - 非敏感环境变量配置
# ============================================
# ConfigMap 用于存储配置数据，不包含敏感信息
# 敏感信息（密码、API Key）应存储在 Secret 中
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexusnote-config
  namespace: nexusnote
data:
  NODE_ENV: "production"
  PORT: "3000"
  HOCUSPOCUS_PORT: "1234"
  NEXT_PUBLIC_APP_URL: "https://juanie.art"
  AUTH_TRUST_HOST: "true"
  NEXTAUTH_URL: "https://juanie.art"
  # OAuth Providers（GitHub 登录配置）
  AUTH_GITHUB_ID: "Ov23li5kloVVHQeOSefR"
  AUTH_GITHUB_SECRET: "3e6be8df8fefb894da3b9bf5c8bc3e23030fb666"

---
# ============================================
# 2. Deployment - Web 应用部署
# ============================================
# Deployment 管理 Pod 的副本数和更新策略
# 支持滚动更新、回滚、自动扩缩容
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-web
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-web
  template:
    metadata:
      labels:
        app: nexusnote-web
    spec:
      imagePullSecrets:
        # 用于拉取私有镜像（GitHub Container Registry）
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          # 使用 Next.js Standalone 模式启动（无需 full Node.js 环境）
          command: ["node", ".next/standalone/server.js"]
          ports:
            - containerPort: 3000
              name: http
          envFrom:
            # 从 ConfigMap 注入环境变量
            - configMapRef:
                name: nexusnote-config
            # 从 Secret 注入敏感信息（数据库密码、API Keys）
            - secretRef:
                name: nexusnote-secrets
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"

---
# ============================================
# 3. Deployment - Collab（协作）服务部署
# ============================================
# 基于 Hocuspocus 的 WebSocket 服务器，用于实时协作编辑
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-collab
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-collab
  template:
    metadata:
      labels:
        app: nexusnote-collab
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          # 启动 Hocuspocus WebSocket 服务器
          command: ["node", "apps/web/hocuspocus.js"]
          ports:
            - containerPort: 1234
              name: collab
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"

---
# ============================================
# 4. Deployment - Worker（后台任务）部署
# ============================================
# BullMQ Worker，处理 RAG 索引等后台任务
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-worker
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-worker
  template:
    metadata:
      labels:
        app: nexusnote-worker
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          # 启动 BullMQ Worker
          command: ["node", "apps/web/worker.js"]
          envFrom:
            - configMapRef:
                name: nexusnote-config
            - secretRef:
                name: nexusnote-secrets
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"

---
# ============================================
# 5. Service - Web 服务暴露
# ============================================
# Service 为 Pod 提供稳定的网络访问入口
# ClusterIP 类型：仅集群内部可访问
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000

---
# ============================================
# 6. Service - Collab 服务暴露
# ============================================
# WebSocket 连接服务
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-collab-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote-collab
  ports:
    - protocol: TCP
      port: 1234
      targetPort: 1234
