# ============================================
# 1. ConfigMap - 共享配置
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexusnote-config
  namespace: nexusnote
data:
  PORT: "3002"
  HOCUSPOCUS_PORT: "1234"
  JWT_EXPIRES_IN: "7d"
  JWT_ISSUER: "nexusnote"
  AI_MODEL: "gemini-3-flash-preview"
  AI_MODEL_PRO: "gemini-3-pro-preview"
  AI_MODEL_WEB_SEARCH: "gemini-3-flash-preview-web-search"
  EMBEDDING_MODEL: "Qwen/Qwen3-Embedding-8B"
  EMBEDDING_DIMENSIONS: "4000"
  RERANKER_MODEL: "Qwen/Qwen3-Reranker-8B"
---
# ============================================
# 2. Web 服务 (Next.js API & Frontend)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-web
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-web
  template:
    metadata:
      labels:
        app: nexusnote-web
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          command: ["node", "apps/web/server.js"]
          ports:
            - containerPort: 3002
              name: http
          envFrom:
            - secretRef:
                name: nexusnote-secrets
            - configMapRef:
                name: nexusnote-config
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3002
            initialDelaySeconds: 45
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3002
            initialDelaySeconds: 20
            periodSeconds: 10
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "200m"
              memory: "256Mi"
---
# ============================================
# 3. Collaboration 服务 (Hocuspocus WebSocket)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-collab
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-collab
  template:
    metadata:
      labels:
        app: nexusnote-collab
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          command: ["node", "apps/web/hocuspocus.js"]
          ports:
            - containerPort: 1234
              name: collab
          envFrom:
            - secretRef:
                name: nexusnote-secrets
            - configMapRef:
                name: nexusnote-config
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "128Mi"
---
# ============================================
# 4. Worker 服务 (BullMQ RAG Processor)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexusnote-worker
  namespace: nexusnote
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexusnote-worker
  template:
    metadata:
      labels:
        app: nexusnote-worker
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: app
          image: IMAGE_PLACEHOLDER
          command: ["node", "apps/web/worker.js"]
          envFrom:
            - secretRef:
                name: nexusnote-secrets
            - configMapRef:
                name: nexusnote-config
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "200m"
              memory: "256Mi"
---
# ============================================
# 5. 集群内部 Service 定义
# ============================================
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote-web
  ports:
    - name: http
      port: 80
      targetPort: 3002
---
apiVersion: v1
kind: Service
metadata:
  name: nexusnote-collab-service
  namespace: nexusnote
spec:
  selector:
    app: nexusnote-collab
  ports:
    - name: collab
      port: 1234
      targetPort: 1234
