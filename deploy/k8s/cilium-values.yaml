# ============================================
# Cilium Helm Chart 配置值
# ============================================
# Cilium 是基于 eBPF 的 Kubernetes 网络和安全解决方案
# 替代了 kube-proxy，提供高性能网络、网络策略、可观测性
# 使用方式: helm install cilium cilium/cilium -n kube-system -f cilium-values.yaml

# ============================================
# 核心功能配置
# ============================================

# 启用 kube-proxy 替换
# Cilium 使用 eBPF 直接操作网络栈，无需 kube-proxy
# 性能更高，延迟更低，支持更复杂的负载均衡算法
kubeProxyReplacement: true

# 启用 Gateway API 支持
# Gateway API 是下一代 Kubernetes API 标准，比 Ingress 更强大
# Cilium 实现了 Gateway API，提供 L4/L7 路由、流量镜像、故障注入等功能
gatewayAPI:
  enabled: true

# 启用 Host Network 模式
# 允许 Cilium 使用主机网络，绕过 NodePort 限制
# 性能更好，适合边缘计算场景
hostNetwork:
  enabled: true

# ============================================
# K3s 兼容配置
# ============================================

# K3s API Server 地址
# K3s 默认使用 127.0.0.1:6443，与标准 K8s 不同
k8sServiceHost: 127.0.0.1
k8sServicePort: 6443

# ============================================
# Operator 配置
# ============================================

# Cilium Operator 副本数
# Operator 负责管理 Cilium Agent、处理 IPAM、网络策略等
operator:
  replicas: 1

# ============================================
# Hubble 可观测性配置
# ============================================

# Hubble 是 Cilium 的可观测性工具，提供：
# - 实时网络流量可视化
# - 服务依赖图
# - 网络延迟监控
# - 安全事件检测
hubble:
  enabled: true
  # Hubble Relay: 将 Hubble 数据暴露为 gRPC 服务
  relay:
    enabled: true
  # Hubble UI: Web 界面，可视化网络流量
  ui:
    enabled: true

# ============================================
# L2 通告配置
# ============================================

# 启用 L2 通告
# 允许 Pod IP 通过 ARP 通告到集群外部
# 适合需要外部直接访问 Pod 的场景（如 MetalLB）
l2announcements:
  enabled: true

# ============================================
# 外部 IP 配置
# ============================================

# 启用 ExternalIP 支持
# 允许 Service 使用外部 IP 地址
externalIPs:
  enabled: true

# ============================================
# HostPort 配置
# ============================================

# 启用 HostPort 支持
# 允许容器使用 hostPort，直接映射到主机端口
# 注意：会绕过 Cilium 网络策略，有安全风险
hostPort:
  enabled: true

# ============================================
# Load Balancer 配置
# ============================================

# L7 负载均衡配置
loadBalancer:
  l7:
    # 使用 Envoy 作为 L7 负载均衡后端
    # Envoy 是高性能的 L7 代理，支持 HTTP/gRPC 路由、故障注入、限流
    backend: envoy
    # dedicated 模式: 每个 LB 一个 Envoy 实例
    # shared 模式: 多个 LB 共享一个 Envoy 实例
    mode: dedicated

# Envoy 配置
envoy:
  enabled: true
  # 容器安全上下文
  # privileged: true 允许 Envoy 使用特权模式，访问主机网络
  # 注意：有安全风险，仅在有信任基础的环境使用
  containerSecurityContext:
    privileged: true
  # 使用 Host Network，绕过 NodePort 限制
  hostNetwork: true

# ============================================
# Ingress Controller 配置
# ============================================

# 禁用传统 Ingress Controller
# Cilium 现在推荐使用 Gateway API 而非 Ingress
ingressController:
  enabled: false

# ============================================
# IPAM 配置
# ============================================

# IPAM (IP Address Management) 模式
# kubernetes: 使用 Kubernetes 的 IPAM
# cluster-pool: Cilium 自己管理 IP 池
# multi-pool: 多个 IP 池
ipam:
  mode: kubernetes
