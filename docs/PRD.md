# 产品需求文档 (PRD): NexusNote AI 智能知识库

| 文档属性 | 内容 |
| :--- | :--- |
| **版本号** | v2.0.0 |
| **状态** | **已批准** |
| **最后更新** | 2025-01 |

---

## 1. 产品概述

### 1.1 产品定位
NexusNote 是一款 **Local-First**（离线优先）的 AI 驱动智能知识库，对标 Notion AI。核心差异化价值：
- **离线可用**：断网状态下完整编辑能力，联网后自动同步
- **AI 原生**：深度集成 LLM，支持上下文感知的智能写作
- **实时协作**：多人同时编辑，冲突自动解决

### 1.2 目标用户
- 个人知识管理者（笔记、写作、学习）
- 小型团队（文档协作、知识沉淀）
- 内容创作者（AI 辅助写作）

### 1.3 核心价值主张
| 价值点 | 描述 |
|--------|------|
| **效率** | AI 快速生成草稿、总结、润色 |
| **流畅** | 流式响应，无等待焦虑 |
| **可靠** | 离线优先，数据不丢失 |
| **协作** | 实时同步，所见即所得 |

---

## 2. 用户故事

### 2.1 核心用户故事

#### US-01: 离线编辑
> 作为用户，我希望在没有网络的情况下也能正常编辑文档，网络恢复后自动同步，这样我在飞机上或地铁里也能高效工作。

**验收标准：**
- [ ] 断网状态下可正常创建、编辑文档
- [ ] 联网后 5 秒内自动同步
- [ ] 同步冲突自动解决，无需人工干预

#### US-02: AI 侧边栏对话
> 作为用户，我希望在侧边栏与 AI 对话，AI 能流式回答我的问题，就像 ChatGPT 一样。

**验收标准：**
- [ ] 点击顶部 "AI Assistant" 图标打开侧边栏
- [ ] 输入问题后立即显示用户消息
- [ ] AI 回复逐字显示（打字机效果）
- [ ] 支持多轮对话，保留上下文
- [ ] 提供"停止生成"按钮

#### US-03: AI 内联写作
> 作为用户，我希望选中文字后通过菜单让 AI "润色"、"翻译"、"缩写"，并实时看到结果。

**验收标准：**
- [ ] 选中文字后出现浮动菜单
- [ ] 提供预设指令：润色、翻译、缩写、续写
- [ ] AI 生成内容流式插入编辑器
- [ ] 生成期间显示加载状态
- [ ] 支持取消生成

#### US-04: Slash 命令
> 作为用户，我希望输入 `/ai` 触发 AI 写作，快速生成内容。

**验收标准：**
- [ ] 输入 `/` 显示命令菜单
- [ ] 选择 AI 命令后弹出输入框
- [ ] 生成内容插入当前光标位置

#### US-05: 知识库问答 (RAG)
> 作为用户，我希望 AI 能读取我的笔记内容来回答问题，而不是只依赖通用知识。

**验收标准：**
- [ ] AI 回答时引用相关笔记片段
- [ ] 显示引用来源（文档链接）
- [ ] 新笔记保存后 30 秒内可被检索

#### US-06: 实时协作
> 作为用户，我希望和团队成员同时编辑文档，看到彼此的光标和编辑内容。

**验收标准：**
- [ ] 多人同时编辑无冲突
- [ ] 显示协作者光标位置
- [ ] 显示协作者头像/名称
- [ ] 编辑延迟 < 200ms

---

## 3. 功能需求

### 3.1 模块一：Block 编辑器

#### 3.1.1 基础编辑
| 功能 | 优先级 | 描述 |
|------|--------|------|
| 段落 | P0 | 普通文本段落 |
| 标题 | P0 | H1-H6 标题层级 |
| 列表 | P0 | 有序/无序/待办列表 |
| 代码块 | P1 | 语法高亮 |
| 引用 | P1 | 块引用样式 |
| 分割线 | P2 | 水平分割 |
| 图片 | P1 | 图片上传与显示 |
| 表格 | P2 | 基础表格 |

#### 3.1.2 Block 操作
- 拖拽排序
- 块级菜单（点击 `⋮` 图标）
- 块转换（段落 ↔ 标题 ↔ 列表）

### 3.2 模块二：AI 侧边栏助手

#### 3.2.1 交互流程
```
用户输入 → 显示用户消息 → "思考中..." 骨架屏 → 流式显示回复 → 完成
```

#### 3.2.2 功能点
| 功能 | 描述 |
|------|------|
| 多轮对话 | 保持上下文 messages 数组 |
| 流式输出 | Token 级别逐字显示 |
| 停止生成 | 中断当前生成 |
| 清空对话 | 重置上下文 |
| 复制回复 | 一键复制 AI 回复 |
| 插入文档 | 将回复插入当前文档 |

#### 3.2.3 API 设计
- **端点**: `POST /api/chat`
- **请求**: `{ messages: Message[] }`
- **响应**: `StreamingTextResponse`

### 3.3 模块三：AI 内联助手

#### 3.3.1 触发方式
| 方式 | 描述 |
|------|------|
| 选中文本 | 出现浮动菜单 (BubbleMenu) |
| Slash 命令 | 输入 `/ai` 触发 |
| 快捷键 | `Cmd/Ctrl + J` |

#### 3.3.2 预设指令
| 指令 | Prompt 模板 |
|------|-------------|
| 继续写作 | "Continue writing based on: {selection}" |
| 润色 | "Improve the writing of: {selection}" |
| 缩写 | "Make this shorter: {selection}" |
| 扩写 | "Expand on this: {selection}" |
| 翻译 | "Translate to {language}: {selection}" |
| 修正语法 | "Fix grammar and spelling: {selection}" |
| 解释 | "Explain this: {selection}" |

#### 3.3.3 流式插入机制
**问题**：AI 流式生成时，其他用户可能同时编辑，导致光标冲突。

**解决方案**：StreamingNode 占位符
1. 生成开始 → 插入只读的 `StreamingNode`
2. 流式更新 → 更新 Node 属性（非结构变更）
3. 生成结束 → 替换为普通文本节点

### 3.4 模块四：RAG 知识检索

#### 3.4.1 索引流程
```
文档保存 → 防抖 10s → 推入任务队列 → Worker 处理 → 文本分块 → Embedding → 存储向量
```

#### 3.4.2 检索流程
```
用户提问 → Embedding → 余弦相似度查询 → Top-K 结果 → 组装 Prompt → LLM 生成
```

#### 3.4.3 Prompt 模板
```
你是 NexusNote 知识库助手。根据以下上下文回答用户问题。

## 相关笔记
{context}

## 用户问题
{question}

请基于上述笔记内容回答，如果笔记中没有相关信息，请说明。
```

### 3.5 模块五：实时协作

#### 3.5.1 功能点
| 功能 | 描述 |
|------|------|
| 实时同步 | 字符级同步，延迟 < 200ms |
| 协作光标 | 显示其他用户光标位置 |
| 用户标识 | 光标旁显示用户名/头像 |
| 在线状态 | 显示当前在线协作者列表 |

#### 3.5.2 冲突解决
采用 CRDT（Conflict-free Replicated Data Type）算法，自动合并并发编辑，无需人工干预。

---

## 4. 非功能需求

### 4.1 性能指标
| 指标 | 目标值 | 说明 |
|------|--------|------|
| 首屏加载 (FCP) | < 0.8s | 依赖本地缓存 |
| 输入延迟 | < 16ms | 保证 60fps |
| 同步延迟 | < 200ms | 亚太区网络 |
| AI 首字响应 (TTFB) | < 1.0s | 流式传输 |

### 4.2 可用性
- 离线状态下核心编辑功能 100% 可用
- 网络恢复后自动同步，无需用户操作
- 同步失败时提供重试机制和错误提示

### 4.3 安全性
- API Key 仅在服务端使用，不暴露给前端
- WebSocket 连接需 JWT 鉴权
- AI 接口需验证用户 session

### 4.4 成本控制
- 开发环境限制 `maxTokens: 500`
- 生产环境提供 Token 用量统计
- RAG 索引采用防抖 + 队列，避免重复调用

---

## 5. 里程碑规划

| 阶段 | 交付物 | 核心功能 |
|------|--------|----------|
| **Phase 1** | 离线编辑器 MVP | Tiptap 编辑器 + IndexedDB 存储 |
| **Phase 2** | 协作版本 | 多人实时同步 + 协作光标 |
| **Phase 3** | AI 对话 | 侧边栏 AI 助手 |
| **Phase 4** | AI 写作 | 内联 AI + Slash 命令 |
| **Phase 5** | 智能检索 | RAG 知识库问答 |
| **Phase 6** | 生产就绪 | Docker 部署 + 监控 |

---

## 6. 成功指标

| 指标 | 目标 |
|------|------|
| 日活用户 (DAU) | Phase 6 后 1000+ |
| AI 功能使用率 | 活跃用户中 > 60% |
| 文档同步成功率 | > 99.9% |
| 用户满意度 (NPS) | > 50 |

---

## 7. 风险与依赖

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| OpenAI API 不稳定 | AI 功能不可用 | 接入多模型备选 (Anthropic) |
| Token 成本超支 | 运营亏损 | 设置用量上限 + 付费分层 |
| CRDT 数据损坏 | 用户数据丢失 | 使用成熟的 Yjs 库 |

---

## 附录

### A. 术语表
| 术语 | 解释 |
|------|------|
| Local-First | 离线优先架构，数据先存本地 |
| CRDT | 无冲突复制数据类型 |
| RAG | 检索增强生成 |
| Streaming | 流式传输，逐字显示 |

### B. 参考产品
- Notion AI
- Craft
- Obsidian
